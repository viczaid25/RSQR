@model RSQR.Models.Reporte

@{
    ViewData["Title"] = "Crear Reporte";
    // Lista de clientes
    var clientes = new List<string> {
        "DAIMLER", "FORD", "GENERAL MOTORS", "HITACHI ASTEMO", "HONDA",
        "JTEKT", "MAZDA", "NAVISTAR", "NISSAN", "PACCAR",
        "SCANIA", "STANLEY", "STELLANTIS", "VOLVO"
    };
}

<h1>Crear Reporte</h1>

<h4>Reporte</h4>

<div class="container-fluid">
    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <!--PRIMERA PARTE-->
        <div class="row section-border">
            <div class="col-md-4 section-border">
                <div class="form-group">
                    <label asp-for="Fecha" class="control-label">Fecha</label>
                    <input asp-for="Fecha" class="form-control" type="date"/>
                    <span asp-validation-for="Fecha" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ProblemRank" class="control-label">Ranking del problema</label>
                    <select asp-for="ProblemRank" class="form-control" asp-items="ViewBag.ProblemRankList"></select>
                    <span asp-validation-for="ProblemRank" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-8 section-border">
                <div class="form-group">
                    <label asp-for="DescripcionProblema" class="control-label">Descripción del problema</label>
                    <textarea asp-for="DescripcionProblema" class="form-control" rows="5"></textarea>
                    <span asp-validation-for="DescripcionProblema" class="text-danger"></span>
                </div>
            </div>
        </div>

        <!--SEGUNDA PARTE-->
        <div class="row section-border">
            <div class="col-md-5 section-border">
                <div class="form-group">
                    <label asp-for="UserName" class="control-label">Usuario</label>
                    <input asp-for="UserName" class="form-control" value="@ViewBag.DisplayName" readonly/>
                    <span asp-validation-for="UserName" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Linea" class="control-label">Linea</label>
                    <select asp-for="Linea" class="form-control" asp-items="ViewBag.LineaList">
                        <option value="">-Seleccionar-</option>
                    </select>
                    <span asp-validation-for="Linea" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Tipo" class="control-label">Tipo de Problema</label>
                    <select asp-for="Tipo" class="form-control" asp-items="Html.GetEnumSelectList<TipoReporte>()"></select>
                    <span asp-validation-for="Tipo" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="TituloProblema" class="control-label">Titulo del Problema</label>
                    <input asp-for="TituloProblema" class="form-control" />
                    <span asp-validation-for="TituloProblema" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="CincoM" class="control-label">5M</label>
                    <select asp-for="CincoM" class="form-control" asp-items="Html.GetEnumSelectList<CincoMOpciones>()"></select>
                    <span asp-validation-for="CincoM" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="NumParteAfectado" class="control-label">Numero de Parte Afectado</label>
                    <input asp-for="NumParteAfectado" class="form-control" />
                    <span asp-validation-for="NumParteAfectado" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Descripcion" class="control-label">Descripcion</label>
                    <input asp-for="Descripcion" class="form-control" />
                    <span asp-validation-for="Descripcion" class="text-danger"></span>
                </div>
                @* <div class="form-group">
                    <label asp-for="PreguntasAdicionales" class="control-label">Preguntas Adicionales</label>
                    <input asp-for="PreguntasAdicionales" class="form-control" />
                    <span asp-validation-for="PreguntasAdicionales" class="text-danger"></span>
                </div> *@

                <div class="form-group">
                    <label asp-for="Customer" class="control-label">Cliente</label>
                    <select asp-for="Customer" class="form-control" id="customer-select" required>
                        <option value="">-Seleccionar Cliente-</option>
                        @foreach (var cliente in clientes)
                        {
                            <option value="@cliente">@cliente</option>
                        }
                    </select>
                    <span asp-validation-for="Customer" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="MotherFactory" class="control-label">Fabrica Madre</label>
                    <input asp-for="MotherFactory" class="form-control" />
                    <span asp-validation-for="MotherFactory" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="CustomerPartNumber" class="control-label">Numero de Parte de Cliente</label>
                    <input asp-for="CustomerPartNumber" class="form-control" />
                    <span asp-validation-for="CustomerPartNumber" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Mileage" class="control-label">Millas</label>
                    <input asp-for="Mileage" class="form-control" />
                    <span asp-validation-for="Mileage" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="InvestigationReport" class="control-label">Reporte de Investigacion</label>
                    <input asp-for="InvestigationReport" class="form-control" />
                    <span asp-validation-for="InvestigationReport" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="DateOfClose" class="control-label">Fecha de Cierre</label>
                    <input asp-for="DateOfClose" class="form-control" type="date" />
                    <span asp-validation-for="DateOfClose" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ImpactoPPM" class="control-label">Tiene Impacto en PPM?</label>
                    <select asp-for="ImpactoPPM" class="form-control">
                        <option value="true">Si</option>
                        <option value="false">No</option>
                    </select>
                    <span asp-validation-for="ImpactoPPM" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Responsabilidad" class="control-label">Responsabilidad</label>
                    <select asp-for="Responsabilidad" class="form-control" asp-items="Html.GetEnumSelectList<ResponsabilidadOpciones>()"></select>
                    <span asp-validation-for="Responsabilidad" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-7 section-border">
                <div class="form-group">
                    <label asp-for="QueP" class="control-label">Que es el Problema</label>
                    <input asp-for="QueP" class="form-control" />
                    <span asp-validation-for="QueP" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="PorqueP" class="control-label">Por Que Sucedio?</label>
                    <input asp-for="PorqueP" class="form-control" />
                    <span asp-validation-for="PorqueP" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="DondeP" class="control-label">Donde Ocurrio?</label>
                    <input asp-for="DondeP" class="form-control" />
                    <span asp-validation-for="DondeP" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="QuienP" class="control-label">Quien?</label>
                    <input asp-for="QuienP" class="form-control" />
                    <span asp-validation-for="QuienP" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="CuandoP" class="control-label">Cuando Sucedio el Problema?</label>
                    <input asp-for="CuandoP" class="form-control" type="date" />
                    <span asp-validation-for="CuandoP" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="CuantosP" class="control-label">Cuantas Piezas?</label>
                    <input asp-for="CuantosP" class="form-control" />
                    <span asp-validation-for="CuantosP" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ComoP" class="control-label">Como Se Detecto El Problema?</label>
                    <input asp-for="ComoP" class="form-control" />
                    <span asp-validation-for="ComoP" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Lote" class="control-label">Lote de Produccion Afectado</label>
                    <input asp-for="Lote" class="form-control" />
                    <span asp-validation-for="Lote" class="text-danger"></span>
                </div>

                <!-- Campo oculto para el número de reclamo (int) -->
                <input type="hidden" asp-for="CustomerClaimNumber" id="claim-number" />

                <!-- Campo de visualización (solo lectura) -->
                <div class="form-group">
                    <label class="control-label">Número de Reclamo</label>
                    <input class="form-control" id="claim-display" readonly />
                    <small class="form-text text-muted">Formato: CLIENTE-0001</small>
                </div>

            </div>
        </div>

        <!--TERCERA PARTE-->
        <div class="row">
            <div class="col-md-8 section-border">
                <div id="dynamic-fields">
                    <!-- Aquí se agregan dinámicamente los campos -->
                </div>

                <button type="button" id="add-group-btn" class="btn btn-primary">Agregar grupo</button>

                <script>
                    let index = 0;

                    document.getElementById('add-group-btn').addEventListener('click', function () {
                        // Crear los grupos de campos
                        const div = document.createElement('div');
                        div.classList.add('row'); // Agregar clase 'row' para alinear en una fila

                        div.innerHTML = `
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="ContencionItems_${index}">Contención Item</label>
                                        <input name="ContencionItems[${index}]" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="ContencionActividades_${index}">Contención Actividad</label>
                                        <input name="ContencionActividades[${index}]" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="ContencionResponsables_${index}">Contención Responsable</label>
                                        <input name="ContencionResponsables[${index}]" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="ContencionFechasInicio_${index}">Fecha de Inicio</label>
                                        <input name="ContencionFechasInicio[${index}]" type="date" class="form-control" />
                                    </div>
                                </div>
                            `;

                        document.getElementById('dynamic-fields').appendChild(div);
                        index++;
                    });
                </script>

            </div>
            <div class="col-md-4 section-border">
                <div class="form-group form-check">
                    <label class="form-check-label">
                        <input class="form-check-input" asp-for="AlertaCalidad" /> @Html.DisplayNameFor(model => model.AlertaCalidad)
                    </label>
                </div>
                <div class="form-group">
                    <label asp-for="Disposicion" class="control-label"></label>
                    <input asp-for="Disposicion" class="form-control" />
                    <span asp-validation-for="Disposicion" class="text-danger"></span>
                </div>
                <div class="form-group form-check">
                    <label class="form-check-label">
                        <input class="form-check-input" asp-for="EntrevistaInvolucrados" /> @Html.DisplayNameFor(model => model.EntrevistaInvolucrados)
                    </label>
                </div>
                <div class="form-group">
                    <label asp-for="Comentarios" class="control-label"></label>
                    <input asp-for="Comentarios" class="form-control" />
                    <span asp-validation-for="Comentarios" class="text-danger"></span>
                </div>
            </div>
        </div>

        <!--CUARTA PARTE-->
        <div class="row">
            <div class="col-md-2 section-border">
                <div class="form-group">
                    <label asp-for="Severidad" class="control-label"></label>
                    <input asp-for="Severidad" class="form-control" />
                    <span asp-validation-for="Severidad" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Ocurrencia" class="control-label"></label>
                    <input asp-for="Ocurrencia" class="form-control" />
                    <span asp-validation-for="Ocurrencia" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Deteccion" class="control-label"></label>
                    <input asp-for="Deteccion" class="form-control" />
                    <span asp-validation-for="Deteccion" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="AP_NPR" class="control-label"></label>
                    <input asp-for="AP_NPR" class="form-control" />
                    <span asp-validation-for="AP_NPR" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-5 section-border">
                <div class="form-group">
                    <label asp-for="ModoFalla" class="control-label"></label>
                    <textarea asp-for="ModoFalla" class="form-control" rows="5"></textarea>
                    <span asp-validation-for="ModoFalla" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-5 section-border">
                <div class="form-group">
                    <label asp-for="ControlesEstablecidos" class="control-label"></label>
                    <textarea asp-for="ControlesEstablecidos" class="form-control" rows="5"></textarea>
                    <span asp-validation-for="ControlesEstablecidos" class="text-danger"></span>
                </div>
            </div>
        </div>

        <!--QUINTA PARTE-->
        <div class="row">
            <div class="col-md-12 section-border">
                <div class="form-group">
                    <label asp-for="EvidenciaFotografica" class="control-label">Evidencia Fotografica</label>
                    <input type="file" name="EvidenciaFotografica" class="form-control" multiple/>
                    <span asp-validation-for="EvidenciaFotografica" class="text-danger"></span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <input type="submit" value="CREAR" class="btn btn-primary" />
        </div>
    </form>
</div>

<div>
    <a asp-action="Index">Regresar</a>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.getElementById('customer-select').addEventListener('change', async function () {
            const customer = this.value;
            const displayField = document.getElementById('claim-display');
            const numericField = document.getElementById('claim-number');

            if (!customer) {
                displayField.value = '';
                numericField.value = '';
                return;
            }

            try {
                displayField.value = 'Generando número...';

                const response = await fetch(`/Reportes/GetNextClaimNumber?customer=${encodeURIComponent(customer)}`);
                if (!response.ok) throw new Error('Error en la respuesta');

                const data = await response.json();
                numericField.value = data.nextNumber;
                displayField.value = `${customer}-${data.nextNumber.toString().padStart(4, '0')}`;
            } catch (error) {
                console.error('Error:', error);
                displayField.value = 'Error al generar número';
                numericField.value = '';
            }
        });
    </script>
}
